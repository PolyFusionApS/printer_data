[extruder_stepper feeder1]
extruder: extruder
step_pin: Feeder_1: F_STEP
dir_pin: !Feeder_1: F_DIR
enable_pin: !Feeder_1: F_ENABLE
microsteps: 16
rotation_distance: 26.1922862783
gear_ratio: 3:1

[tmc2209 extruder_stepper feeder1]
uart_pin: Feeder_1: F_TMCUART
interpolate: false
run_current: 0.6
sense_resistor: 0.11
stealthchop_threshold: 0

[temperature_sensor Feeder_1_MCU]
sensor_type: temperature_mcu
sensor_mcu: Feeder_1

[neopixel Feeder_1_led]
pin: Feeder_1: LED_BUTTON_RGB
color_order: GRB
initial_RED: 1.0
initial_GREEN: 0.0
initial_BLUE: 0.0

[gcode_button Feeder_1_button]
pin: ^!Feeder_1: LED_BUTTON
press_gcode:
  #printer["gcode_button Feeder_1_Switch"].state == "PRESSED" and 
  
  {% if printer["gcode_button Feeder_1_Switch"].state == "PRESSED" %}
    {% if printer["filament_switch_sensor Head_1_Filament_Sensor"].filament_detected %}
      M118 "Feeder 1 unload started!"
      SET_LED_TEMPLATE LED=Feeder_1_led INDEX=1 TEMPLATE=led_orange
      UNLOAD_FILAMENT
      SET_FILAMENT_STATUS
    {% else %}
      SET_LED_TEMPLATE LED=Feeder_1_led INDEX=1 TEMPLATE=led_blue
      M118 "Loading filament in Feeder 1"
      LOAD_FILAMENT
      SET_FILAMENT_STATUS
    {% endif %}
  {% endif %}
    
release_gcode:
  #SET_FILAMENT_STATUS

#[filament_switch_sensor Feeder_1_Switch]
#switch_pin: ^Feeder_1: F_FS
#runout_gcode:
#  SET_FILAMENT_STATUS
#  M118 Filament runout at Feeder 1
  #PAUSE # [pause_resume] is required in printer.cfg
#  M117 Filament switch runout
#insert_gcode:
#  SET_FILAMENT_STATUS
#  M118 Filament insert at Feeder 1
  #LOAD_FILAMENT
#  M117 Filament switch inserted

[gcode_button Feeder_1_Switch]
pin: ^Feeder_1: F_FS
press_gcode:
  #M118 "Feeder 1 active"
  SET_FILAMENT_STATUS
#  { action_respond_info('Feeder 2 detected filament') }
release_gcode:
  #M118 "Feeder 1 empty"
  SET_FILAMENT_STATUS
#  { action_respond_info('') }


[filament_motion_sensor Feeder_1_Encoder]
switch_pin: ^Feeder_1: F_FENC # motion sensor IO is PC2
detection_length: 2.88 # accuracy of motion sensor 2.88mm
extruder: extruder
pause_on_runout: False
runout_gcode:
  M118 Filament motion at feeder 1 stopped, print paused!
#  PAUSE # [pause_resume] is required in printer.cfg
#  M117 Filament encoder runout
#insert_gcode:
#  M117 Filament encoder inserted

#[gcode_button Feeder_1_Switch]
#pin: ^Feeder_1: F_FS
#press_gcode:
#  { action_respond_info('Feeder 1 detected filament') }
#   A list of G-Code commands to execute when the button is pressed.
#   G-Code templates are supported. This parameter must be provided.
#release_gcode:
#  { action_respond_info('') }
#   A list of G-Code commands to execute when the button is released.
#   G-Code templates are supported. The default is to not run any
#   commands on a button release.



